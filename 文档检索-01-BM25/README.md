# 1.项目概述

本文采用BM25算法进行文档检索，算法主要步骤如下图所示：  

![i](https://github.com/zenghang-feng/NLP_Tasks/blob/main/文档检索-01-BM25/bm25.png)

# 2.程序实现

```
import re
import jieba
import pandas as pd
import numpy as np

##############################################################################
# 数据准备
##############################################################################
# 读取停用词表 =================================================================
file_stop_words = "hit_stopwords.txt"
with open(file_stop_words, 'r', encoding='utf-8') as f:
    stop_w_l = [word.strip('\n') for word in f.readlines()]

# 读取和处理知识库文本 ==========================================================
file_klg = "knowledge_docs.xlsx"
df_klg = pd.read_excel(file_klg)
# 对文档分词，生成的结果存储在列表中，每个词作为列表中一个元素 -------------------------
df_klg['文档内容_分词'] = df_klg.apply(lambda row: jieba.lcut(re.sub(r'[\W]', '', row['文档内容'])), axis=1)
# 去除停用词，生成的结果存储在字符串中，每个词之间以空格分隔 --------------------------
df_klg['文档内容_分词_去停用词'] = df_klg.apply(lambda row: [w for w in row['文档内容_分词'] if w not in stop_w_l], axis=1)
# 将文档的分词列表存储在一个列表中 -----------------------------------------------
docs_words = df_klg['文档内容_分词_去停用词'].tolist()

# 读取和处理用户问题 ============================================================
query_str = "中国和美国的经济哪个好"
query_words = [w for w in jieba.lcut(re.sub(r'[\W]', '', query_str)) if w not in stop_w_l]


##############################################################################
# 实现BM25算法
##############################################################################
def bm25(query: list, docs: list, k1: float, b: float) -> list:
    # 计算各个文档的平均长度 --------------------------------
    doc_nums = len(docs)
    avgdl = sum([len(doc) for doc in docs]) / doc_nums

    # 计算各个文档中的词的词频 ------------------------------
    docs_wc = []
    for doc in docs:
        doc_words_count = {}
        for w in doc:
            if w in doc_words_count:
                doc_words_count[w] += 1
            else:
                doc_words_count[w] = 1
        docs_wc.append(doc_words_count)

    # 计算query中每个词所出现在的文档的数量 ------------------
    query_wds = {}
    for wq in query:
        count = 0
        for doc_words_count in docs_wc:
            if wq in doc_words_count:
                count += 1
        query_wds[wq] = count

    # 计算query与每个文档的相似度分值 -----------------------
    res = []
    for i in range(doc_nums):
        doc = docs[i]
        doc_words_count = docs_wc[i]
        score_sum = 0
        for wq in query:
            n_wq = query_wds[wq]
            idf_wq = np.log((doc_nums - n_wq + 0.5) / (n_wq + 0.5) + 1)

            f_wq = 0
            if wq in doc_words_count:
                f_wq = doc_words_count[wq]
            score = idf_wq * (f_wq * (k1 + 1)) / (f_wq + k1 * (1 - b + b * (len(doc)/avgdl)))
            score_sum = score_sum + score

        res.append(score_sum)

    return res


##############################################################################
# 进行文档检索
##############################################################################
# type = isinstance([1, 2], list)
res = bm25(query=query_words, docs=docs_words, k1=1.5, b=0.75)
idx = res.index(max(res))
print(query_words)
print(docs_words[idx])

```

输出如下：
```
['中国', '美国', '经济', '好']
['中国', '美国', '全球', '经济体', '中', '两大', '巨头', '未来', '经济', '前景', '会', '受到', '多种', '复杂', '因素', '影响', '包括', '不', '限于', '政策', '调整', '技术创新', '国际', '关系', '人口', '结构', '变化', '资源分配', '利用效率', '市场', '开放度', '全球', '经济', '增长', '动力', '适应能力', '中国', '机遇', '中国', '经济', '具有', '庞大', '内需', '市场', '持续', '城市化', '进程', '不断', '提升', '科技', '创新能力', '不断', '优化', '产业结构', '中国政府', '推行', '高质量', '发展', '策略', '致力于', '解决', '不', '平衡', '不', '充分', '发展', '问题', '强化', '创新', '驱动', '有望', '产业', '升级', '数字', '经济', '绿色', '能源', '方面', '取得', '突破性', '进展', '挑战', '中国', '需要', '应对', '人口老龄化', '带来', '劳动力', '供给', '压力', '环境', '持续', '发展', '问题', '金融风险', '管控', '外部环境', '不确定性', '增加', '国际贸易', '摩擦', '技术', '封锁', '挑战', '美国', '优势', '美国', '拥有', '成熟', '市场经济', '体系', '强大', '创新能力', '灵活', '资本', '市场', '丰富', '高端', '人力资源', '全球', '科技', '创新', '金融服务', '领域', '仍', '保持', '显著', '竞争', '优势', '美元', '世界', '储备', '货币', '地位', '确保', '国际', '金融体系', '中', '核心作用', '挑战', '美国', '面临', '国内', '政治', '极化', '导致', '政策', '连续性', '稳定性', '降低', '基础设施', '老化', '收入', '不', '平等', '加剧', '公共', '债务', '高企', '全球化', '逆流', '可能', '带来', '供应链', '重构', '问题', '总体', '来看', '中美', '两国', '经济', '前景', '取决于', '效应', '挑战', '把握', '发展', '机遇', '双方', '都', '潜力', '保持', '长期', '增长', '实际', '表现', '取决于', '未来', '数十年', '内', '内外部', '政策', '调整', '全球', '经济', '环境', '变迁', '从长远看', '全球', '治理', '格局', '变化', '新', '科技', '革命', '持续', '发展', '要求', '都', '深刻影响', '两', '国', '全球', '经济', '版图', '重塑', '无法', '简单', '断定', '国家', '经济', '前景', '绝对', '更好', '应该', '综合', '考量', '多维度', '因素', '动态', '演变', '过程']
```
